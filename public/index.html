<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .header h1 {
      font-size: 2.8em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.9;
    }

    .main-content {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .tab {
      flex: 1;
      padding: 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #6c757d;
    }

    .tab:hover {
      background: #e9ecef;
      color: #495057;
    }

    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .tab-content {
      padding: 30px;
      min-height: 600px;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Dashboard Styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
      transform: translateY(0);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(76, 175, 80, 0.4);
    }

    .stat-card.blue {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
    }

    .stat-card.orange {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
    }

    .stat-card.purple {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      box-shadow: 0 8px 25px rgba(156, 39, 176, 0.3);
    }

    .stat-number {
      font-size: 3em;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 1.1em;
      opacity: 0.9;
    }

    /* Form Styles */
    .form-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 1em;
    }

    input, select, textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin: 5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }

    .btn-info {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }

    /* Table Styles */
    .table-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      margin-top: 25px;
    }

    .jobs-table {
      width: 100%;
      border-collapse: collapse;
    }

    .jobs-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }

    .jobs-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
    }

    .jobs-table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-new { background: #e3f2fd; color: #1976d2; }
    .status-scheduled { background: #f3e5f5; color: #7b1fa2; }
    .status-completed { background: #e8f5e8; color: #388e3c; }
    .status-cancelled { background: #ffebee; color: #d32f2f; }

    /* Messages */
    .message {
      padding: 15px 20px;
      border-radius: 10px;
      margin: 15px 0;
      font-weight: 500;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.loading {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
      text-align: center;
    }

    /* Customer Suggestions */
    .customer-suggestions {
      position: absolute;
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      width: 100%;
      display: none;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .customer-suggestion {
      padding: 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s ease;
    }

    .customer-suggestion:hover {
      background: #f8f9fa;
    }

    .customer-suggestion:last-child {
      border-bottom: none;
    }

    /* Job ID Preview */
    .job-id-preview {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border: 2px solid #bbdefb;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      text-align: center;
      display: none;
    }

    .job-id-preview h4 {
      color: #1976d2;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .preview-job-id {
      font-size: 2.5em;
      font-weight: bold;
      color: #1976d2;
      margin: 15px 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 2em;
      }
      
      .tab-content {
        padding: 20px;
      }
      
      .stat-number {
        font-size: 2em;
      }
    }

    /* Loading Animation */
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Filter Section */
    .filter-section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      align-items: end;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå</h1>
      <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</p>
    </div>

    <div class="main-content">
      <div class="tabs">
        <button class="tab active" onclick="showTab('dashboard')">
          üìä Dashboard
        </button>
        <button class="tab" onclick="showTab('jobs-list')">
          üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
        </button>
        <button class="tab" onclick="showTab('new-job')">
          ‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        </button>
        <button class="tab" onclick="showTab('settings')">
          ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </button>
      </div>

      <div class="tab-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-pane active">
          <h2 style="margin-bottom: 30px; color: #333;">üìä Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
          
          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-number" id="total-jobs">-</div>
              <div class="stat-label">üìã ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            
            <div class="stat-card blue">
              <div class="stat-number" id="completed-jobs">-</div>
              <div class="stat-label">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div>
            </div>
            
            <div class="stat-card orange">
              <div class="stat-number" id="pending-jobs">-</div>
              <div class="stat-label">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
            </div>
            
            <div class="stat-card purple">
              <div class="stat-number" id="today-jobs">-</div>
              <div class="stat-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
          </div>
          
          <div class="form-section">
            <h3 style="margin-bottom: 20px; color: #333;">üìà ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h3>
            <div id="recent-jobs-summary">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <!-- Jobs List Tab -->
        <div id="jobs-list" class="tab-pane">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="color: #333;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            <button class="btn btn-info" onclick="loadJobs()">
              üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
          </div>
          
          <div class="filter-section">
            <h3 style="margin-bottom: 20px; color: #333;">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <div class="filter-grid">
              <div class="form-group">
                <label for="status-filter">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <select id="status-filter">
                  <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                  <option value="New">New</option>
                  <option value="Scheduled">Scheduled</option>
                  <option value="In progress">In progress</option>
                  <option value="Done">Done</option>
                  <option value="‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="team-filter">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°</label>
                <select id="team-filter">
                  <option value="">‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡∏°</option>
                  <option value="‡∏ó‡∏µ‡∏° A">‡∏ó‡∏µ‡∏° A</option>
                  <option value="‡∏ó‡∏µ‡∏° B">‡∏ó‡∏µ‡∏° B</option>
                </select>
              </div>
              
              <div class="form-group">
                <button class="btn btn-info" onclick="applyFilters()">
                  üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                </button>
                <button class="btn btn-warning" onclick="clearFilters()">
                  üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á
                </button>
              </div>
            </div>
          </div>
          
          <div id="jobs-container">
            <div class="loading-spinner"></div>
          </div>
        </div>

        <!-- New Job Tab -->
        <div id="new-job" class="tab-pane">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="color: #333;">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
            <button class="btn btn-info" onclick="generateJobId()">
              üé≤ ‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            </button>
          </div>
          
          <!-- Job ID Preview -->
          <div id="job-id-preview" class="job-id-preview">
            <h4>üìã ‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</h4>
            <div class="preview-job-id" id="preview-job-id">-</div>
            <small style="color: #666;">‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</small>
          </div>
          
          <form id="newJobForm">
            <div class="form-section">
              <h3 style="margin-bottom: 20px; color: #333;">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
              
              <div class="form-grid">
                <div class="form-group" style="position: relative;">
                  <label for="customer">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *</label>
                  <input type="text" id="customer" name="customer" required 
                         autocomplete="off" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                  <div id="customerSuggestions" class="customer-suggestions"></div>
                </div>
                
                <div class="form-group">
                  <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                  <input type="tel" id="phone" name="phone" placeholder="08X-XXX-XXXX">
                </div>
              </div>

              <div class="form-group">
                <label for="address">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                <textarea id="address" name="address" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
              </div>
            </div>

            <div class="form-section">
              <h3 style="margin-bottom: 20px; color: #333;">üîß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</h3>
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô *</label>
                  <select id="type" name="type" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</option>
                    <option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</option>
                    <option value="‡∏ã‡πà‡∏≠‡∏°">‡∏ã‡πà‡∏≠‡∏°</option>
                    <option value="‡∏•‡πâ‡∏≤‡∏á">‡∏•‡πâ‡∏≤‡∏á/‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</option>
                    <option value="‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                    <option value="‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô">‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</option>
                    <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="team">‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</label>
                  <select id="team" name="team">
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°</option>
                    <option value="‡∏ô‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà">‡∏ô‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà</option>
                    <option value="‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                  </select>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
                  <select id="status" name="status" required>
                    <option value="New">New</option>
                    <option value="Need Info">Need Info</option>
                    <option value="Ready to schedule">Ready to schedule</option>
                    <option value="Scheduled">Scheduled</option>
                    <option value="Rescheduled">Rescheduled</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="zone">‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
                  <input type="text" id="zone" name="zone" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û, ‡∏ö‡∏≤‡∏á‡∏ô‡∏≤, ‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á">
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 style="margin-bottom: 20px; color: #333;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</h3>
              
              <div class="form-grid">
                <div class="form-group">
                  <label for="date_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                  <select id="date_type" name="date_type" onchange="toggleDateInput()">
                    <option value="single">‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                    <option value="range">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="time_window">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                  <select id="time_window" name="time_window" onchange="updateTimeBasedOnWindow()">
                    <option value="AM">‡πÄ‡∏ä‡πâ‡∏≤ (AM) 09:00-12:00</option>
                    <option value="PM">‡∏ö‡πà‡∏≤‡∏¢ (PM) 13:00-17:00</option>
                    <option value="All Day">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô 08:00-18:00</option>
                    <option value="Custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á</option>
                  </select>
                </div>
              </div>

              <!-- ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
              <div id="single-date-section" class="form-grid">
                <div class="form-group">
                  <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
                  <input type="date" id="date" name="date">
                </div>
              </div>

              <!-- ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
              <div id="date-range-section" class="form-grid" style="display: none;">
                <div class="form-group">
                  <label for="start_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô *</label>
                  <input type="date" id="start_date" name="start_date" onchange="updateDateRangePreview()">
                </div>
                
                <div class="form-group">
                  <label for="end_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î *</label>
                  <input type="date" id="end_date" name="end_date" onchange="updateDateRangePreview()">
                </div>
              </div>

              <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
              <div id="date-range-preview" class="form-section" style="background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%); border: 2px solid #4CAF50; display: none; margin-top: 20px;">
                <h4 style="color: #2e7d32; margin-bottom: 10px;">üìÖ ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h4>
                <div style="font-size: 18px; font-weight: bold; color: #2e7d32;" id="range-display">-</div>
                <small style="color: #4a4a4a;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Events ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</small>
              </div>

              <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á" -->
              <div id="custom-time-section" class="form-grid" style="display: none;">
                <div class="form-group">
                  <label for="start_time">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                  <input type="time" id="start_time" name="start_time" value="09:00">
                </div>
                
                <div class="form-group">
                  <label for="end_time">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                  <input type="time" id="end_time" name="end_time" value="17:00">
                </div>
              </div>

              <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ -->
              <div id="preset-time-display" class="form-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%); border: 2px solid #2196F3; margin-top: 20px;">
                <h4 style="color: #1976d2; margin-bottom: 10px;">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
                <div style="font-size: 18px; font-weight: bold; color: #1976d2;" id="time-display">09:00 - 12:00</div>
                <small style="color: #4a4a4a;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</small>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="add_to_calendar">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô Google Calendar</label>
                  <select id="add_to_calendar" name="add_to_calendar">
                    <option value="Yes">‡πÉ‡∏ä‡πà - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</option>
                    <option value="No">‡πÑ‡∏°‡πà - ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</option>
                  </select>
                  <small style="color: #666; font-size: 12px;">
                    ‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÉ‡∏ä‡πà" + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Scheduled/Rescheduled ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                  </small>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3 style="margin-bottom: 20px; color: #333;">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
              
              <div class="form-group">
                <label for="details">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</label>
                <textarea id="details" name="details" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô"></textarea>
              </div>

              <div class="form-group">
                <label for="notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="notes" name="notes" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"></textarea>
              </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
              <button type="submit" class="btn btn-success" style="font-size: 18px; padding: 20px 40px;">
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
              </button>
            </div>
          </form>

          <div id="form-message"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-pane">
          <h2 style="margin-bottom: 30px; color: #333;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
          
          <div class="form-section">
            <h3 style="margin-bottom: 20px; color: #333;">üîß ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <div class="form-grid">
              <button class="btn btn-info" onclick="testConnection()">
                üîó ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API
              </button>
              <button class="btn btn-success" onclick="testCalendar()">
                üìÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Calendar
              </button>
              <button class="btn btn-warning" onclick="loadSystemInfo()">
                ‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö
              </button>
              <button class="btn btn-primary" onclick="auditCalendar()">
                üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
              </button>
              <button class="btn btn-purple" onclick="syncFromCalendar()" style="background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); color: white;">
                üîÑ Sync ‡∏à‡∏≤‡∏Å Calendar
              </button>
            </div>
          </div>

          <!-- Auto-Detection System Section -->
          <div class="form-section">
            <h3 style="margin-bottom: 20px; color: #333;">üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
            <p style="color: #666; margin-bottom: 20px;">
              ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            </p>
            
            <div class="form-grid">
              <button class="btn btn-primary" onclick="getAutoDetectionStatus()">
                üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
              </button>
              <button class="btn btn-success" onclick="runAutoDetectionNow()">
                üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
              </button>
              <button class="btn btn-info" onclick="startAutoDetection()">
                ‚ñ∂Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
              </button>
              <button class="btn btn-warning" onclick="stopAutoDetection()">
                ‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
              </button>
            </div>
            
            <div id="auto-detection-status" style="margin-top: 20px;">
              <div class="form-section">
                <h4 style="color: #333;">ü§ñ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h4>
                <p id="auto-detection-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
              </div>
            </div>
          </div>

          <!-- Calendar Audit Section -->
          <div class="form-section">
            <h3 style="margin-bottom: 20px; color: #333;">üìä ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</h3>
            <p style="color: #666; margin-bottom: 20px;">
              ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
            </p>
            
            <div id="calendar-audit-results" style="margin-bottom: 20px;">
              <div class="form-section">
                <h4 style="color: #333;">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h4>
                <p id="audit-summary-text">‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
              </div>
            </div>

            <div class="form-grid" id="sync-actions" style="display: none;">
              <button class="btn btn-success" onclick="syncMissingEvents()">
                üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
              </button>
              <button class="btn btn-info" onclick="auditCalendar()">
                üîÑ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
          </div>

          <div id="settings-results">
            <div class="form-section">
              <h4 style="color: #333;">üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h4>
              <p id="system-status-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let allJobsData = [];
    let customersData = [];
    let systemConfig = {};

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadSystemConfig();
      loadDashboard();
    });

    // Tab management
    function showTab(tabName) {
      // Hide all tab panes
      const tabPanes = document.querySelectorAll('.tab-pane');
      tabPanes.forEach(pane => pane.classList.remove('active'));

      // Remove active class from all tabs
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked tab
      event.target.classList.add('active');

      // Load data when switching to certain tabs
      if (tabName === 'dashboard') {
        loadDashboard();
      } else if (tabName === 'jobs-list') {
        loadJobs();
      } else if (tabName === 'settings') {
        loadSystemInfo();
      }
    }

    // Load system configuration
    async function loadSystemConfig() {
      try {
        const response = await fetch('/api/config');
        systemConfig = await response.json();
        console.log('System config loaded:', systemConfig);
        updateFormOptions();
      } catch (error) {
        console.error('Failed to load system config:', error);
        showMessage('form-message', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö: ' + error, 'error');
      }
    }

    // Update form options based on config
    function updateFormOptions() {
      if (systemConfig.teams) {
        const teamSelect = document.getElementById('team');
        teamSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°</option>';
        systemConfig.teams.forEach(team => {
          const option = document.createElement('option');
          option.value = team;
          option.textContent = team;
          teamSelect.appendChild(option);
        });
      }

      if (systemConfig.zones) {
        const zoneSelect = document.getElementById('zone');
        zoneSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï</option>';
        systemConfig.zones.forEach(zone => {
          const option = document.createElement('option');
          option.value = zone;
          option.textContent = zone;
          zoneSelect.appendChild(option);
        });
      }
    }

    // Dashboard functions
    async function loadDashboard() {
      try {
        const response = await fetch('/api/jobs');
        const jobs = await response.json();
        displayDashboardSummary(jobs);
      } catch (error) {
        console.error('Failed to load dashboard data:', error);
      }
    }

    function displayDashboardSummary(jobs) {
      if (!jobs) jobs = [];
      
      const today = new Date().toISOString().split('T')[0];
      const totalJobs = jobs.length;
      const completedJobs = jobs.filter(job => 
        job.status === 'Done' || job.status === 'Closed' || job.status === '‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
      ).length;
      const pendingJobs = jobs.filter(job => 
        job.status === 'New' || job.status === 'Need Info' || job.status === 'Ready to schedule'
      ).length;
      const todayJobs = jobs.filter(job => job.date === today).length;
      
      document.getElementById('total-jobs').textContent = totalJobs;
      document.getElementById('completed-jobs').textContent = completedJobs;
      document.getElementById('pending-jobs').textContent = pendingJobs;
      document.getElementById('today-jobs').textContent = todayJobs;
      
      // Display recent jobs
      const recentJobs = jobs.slice(0, 5);
      let html = '';
      if (recentJobs.length > 0) {
        html = `
          <div class="table-container">
            <table class="jobs-table">
              <thead>
                <tr>
                  <th>Job ID</th>
                  <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                  <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        recentJobs.forEach(job => {
          html += `
            <tr>
              <td><strong>${job.job_id || ''}</strong></td>
              <td>${job.customer || ''}</td>
              <td>${job.type || ''}</td>
              <td><span class="status-badge status-${getStatusClass(job.status)}">${job.status || ''}</span></td>
              <td>${job.date || ''}</td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
      } else {
        html = '<div class="message">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</div>';
      }
      
      document.getElementById('recent-jobs-summary').innerHTML = html;
    }

    // Jobs management
    async function loadJobs() {
      document.getElementById('jobs-container').innerHTML = '<div class="loading-spinner"></div>';
      
      try {
        const response = await fetch('/api/jobs');
        const jobs = await response.json();
        allJobsData = jobs;
        applyFilters();
      } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('jobs-container').innerHTML = 
          '<div class="message error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô: ' + error + '</div>';
      }
    }

    function applyFilters() {
      if (!allJobsData || allJobsData.length === 0) {
        document.getElementById('jobs-container').innerHTML = '<div class="message">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</div>';
        return;
      }

      const statusFilter = document.getElementById('status-filter').value;
      const teamFilter = document.getElementById('team-filter').value;
      
      let filteredJobs = allJobsData;
      
      if (statusFilter) {
        filteredJobs = filteredJobs.filter(job => job.status === statusFilter);
      }
      
      if (teamFilter) {
        filteredJobs = filteredJobs.filter(job => job.team === teamFilter);
      }
      
      displayJobs(filteredJobs);
    }

    function clearFilters() {
      document.getElementById('status-filter').value = '';
      document.getElementById('team-filter').value = '';
      applyFilters();
    }

    function displayJobs(jobs) {
      const container = document.getElementById('jobs-container');
      
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<div class="message">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
        return;
      }

      let html = `
        <div style="margin-bottom: 20px;">
          <p><strong>üìä ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ${jobs.length} ‡∏á‡∏≤‡∏ô ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allJobsData.length} ‡∏á‡∏≤‡∏ô</strong></p>
        </div>
        <div class="table-container">
          <table class="jobs-table">
            <thead>
              <tr>
                <th>Job ID</th>
                <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏ó‡∏µ‡∏°</th>
                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody>
      `;

      jobs.forEach(job => {
        html += `
          <tr>
            <td><strong>${job.job_id || 'N/A'}</strong></td>
            <td>${job.customer || ''}</td>
            <td>${job.type || ''}</td>
            <td><span class="status-badge status-${getStatusClass(job.status)}">${job.status || ''}</span></td>
            <td>${job.team || ''}</td>
            <td>${job.date || ''}</td>
            <td>${job.time_window || ''}</td>
            <td>
              <div style="display: flex; gap: 5px; align-items: center;">
                <select id="status-${job.job_id}" style="padding: 5px; font-size: 12px;">
        `;
        
        if (systemConfig.statuses) {
          systemConfig.statuses.forEach(status => {
            const selected = status === job.status ? ' selected' : '';
            html += `<option value="${status}"${selected}>${status}</option>`;
          });
        }
        
        html += `
                </select>
                <button class="btn btn-info" style="padding: 5px 10px; font-size: 12px;" onclick="updateJobStatus('${job.job_id}')">
                  Update
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function getStatusClass(status) {
      if (!status) return '';
      
      const statusLower = status.toLowerCase();
      if (statusLower.includes('new')) return 'new';
      if (statusLower.includes('scheduled') || statusLower.includes('‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢')) return 'scheduled';
      if (statusLower.includes('done') || statusLower.includes('completed') || statusLower.includes('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')) return 'completed';
      if (statusLower.includes('cancelled')) return 'cancelled';
      return '';
    }

    async function updateJobStatus(jobId) {
      const selectElement = document.getElementById(`status-${jobId}`);
      if (!selectElement || !selectElement.value) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î Update');
        return;
      }
      
      const newStatus = selectElement.value;
      if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á ${jobId} ‡πÄ‡∏õ‡πá‡∏ô "${newStatus}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/jobs/${jobId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus })
        });

        const result = await response.json();

        if (response.ok) {
          showMessage('jobs-container', `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ${jobId} ‚Üí ${newStatus}`, 'success');
          loadJobs(); // Reload jobs
        } else {
          showMessage('jobs-container', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Error updating job status:', error);
        showMessage('jobs-container', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + error, 'error');
      }
    }

    // Customer search functions
    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers');
        customersData = await response.json();
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    function searchCustomers(searchText) {
      const suggestions = document.getElementById('customerSuggestions');
      
      if (!searchText || searchText.length < 2) {
        suggestions.style.display = 'none';
        return;
      }
      
      const matches = customersData.filter(customer => 
        customer.customer_name?.toLowerCase().includes(searchText.toLowerCase()) ||
        customer.aliases?.toLowerCase().includes(searchText.toLowerCase())
      ).slice(0, 5);

      if (matches.length > 0) {
        displayCustomerSuggestions(matches);
      } else {
        suggestions.style.display = 'none';
      }
    }

    function displayCustomerSuggestions(matches) {
      const suggestions = document.getElementById('customerSuggestions');
      suggestions.innerHTML = '';
      
      matches.forEach(customer => {
        const div = document.createElement('div');
        div.className = 'customer-suggestion';
        div.innerHTML = `
          <strong>${customer.customer_name || customer.name}</strong><br>
          <small>${customer.phone_default || customer.phone || ''} | ${customer.address_default || customer.address || ''}</small>
        `;
        div.addEventListener('click', () => selectCustomer(customer));
        suggestions.appendChild(div);
      });
      
      suggestions.style.display = 'block';
    }

    function selectCustomer(customer) {
      document.getElementById('customer').value = customer.customer_name || customer.name;
      document.getElementById('phone').value = customer.phone_default || customer.phone || '';
      document.getElementById('address').value = customer.address_default || customer.address || '';
      document.getElementById('customerSuggestions').style.display = 'none';
    }

    // Job ID generation
    async function generateJobId() {
      try {
        const response = await fetch('/api/jobs');
        const jobs = await response.json();
        
        let maxId = 0;
        jobs.forEach(job => {
          if (job.job_id && job.job_id.startsWith('JOB-')) {
            const idNum = parseInt(job.job_id.replace('JOB-', ''));
            if (!isNaN(idNum) && idNum > maxId) {
              maxId = idNum;
            }
          }
        });

        const nextJobId = `JOB-${String(maxId + 1).padStart(6, '0')}`;
        document.getElementById('preview-job-id').textContent = nextJobId;
        document.getElementById('job-id-preview').style.display = 'block';
      } catch (error) {
        console.error('Error generating job ID:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô: ' + error);
      }
    }

    // Date Range Functions
    function toggleDateInput() {
      const dateType = document.getElementById('date_type').value;
      const singleDateSection = document.getElementById('single-date-section');
      const dateRangeSection = document.getElementById('date-range-section');
      const dateRangePreview = document.getElementById('date-range-preview');
      
      if (dateType === 'single') {
        singleDateSection.style.display = 'block';
        dateRangeSection.style.display = 'none';
        dateRangePreview.style.display = 'none';
      } else {
        singleDateSection.style.display = 'none';
        dateRangeSection.style.display = 'block';
        updateDateRangePreview();
      }
    }

    function updateDateRangePreview() {
      const startDate = document.getElementById('start_date').value;
      const endDate = document.getElementById('end_date').value;
      const preview = document.getElementById('date-range-preview');
      const rangeDisplay = document.getElementById('range-display');
      
      if (startDate && endDate) {
        const startDateObj = new Date(startDate);
        const endDateObj = new Date(endDate);
        
        if (startDateObj <= endDateObj) {
          const diffTime = Math.abs(endDateObj - startDateObj);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
          
          const startFormatted = formatThaiDate(startDateObj);
          const endFormatted = formatThaiDate(endDateObj);
          
          rangeDisplay.textContent = `${startFormatted} - ${endFormatted} (‡∏£‡∏ß‡∏° ${diffDays} ‡∏ß‡∏±‡∏ô)`;
          preview.style.display = 'block';
          preview.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%)';
        } else {
          rangeDisplay.textContent = '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î';
          preview.style.display = 'block';
          preview.style.background = 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)';
        }
      } else {
        preview.style.display = 'none';
      }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function updateTimeBasedOnWindow() {
      const timeWindow = document.getElementById('time_window').value;
      const customTimeSection = document.getElementById('custom-time-section');
      const presetTimeDisplay = document.getElementById('preset-time-display');
      const timeDisplay = document.getElementById('time-display');
      const startTimeInput = document.getElementById('start_time');
      const endTimeInput = document.getElementById('end_time');
      
      if (timeWindow === 'Custom') {
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á
        customTimeSection.style.display = 'block';
        presetTimeDisplay.style.display = 'none';
      } else {
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        customTimeSection.style.display = 'none';
        presetTimeDisplay.style.display = 'block';
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        switch (timeWindow) {
          case 'AM':
            startTimeInput.value = '09:00';
            endTimeInput.value = '12:00';
            timeDisplay.textContent = '09:00 - 12:00';
            break;
          case 'PM':
            startTimeInput.value = '13:00';
            endTimeInput.value = '17:00';
            timeDisplay.textContent = '13:00 - 17:00';
            break;
          case 'All Day':
            startTimeInput.value = '08:00';
            endTimeInput.value = '18:00';
            timeDisplay.textContent = '08:00 - 18:00';
            break;
        }
      }
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.addEventListener('DOMContentLoaded', function() {
      updateTimeBasedOnWindow();
      setupFormSubmit();
    });

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    function setupFormSubmit() {
      const form = document.getElementById('newJobForm');
      if (form) {
        form.addEventListener('submit', submitNewJob);
      }
    }

    // ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
    async function submitNewJob(event) {
      event.preventDefault();
      
      const submitButton = event.target.querySelector('button[type="submit"]');
      const originalText = submitButton.innerHTML;
      
      try {
        // ‡πÅ‡∏™‡∏î‡∏á loading
        submitButton.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        submitButton.disabled = true;
        showMessage('form-message', '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà...', 'loading');
        
        // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
        const formData = new FormData(event.target);
        const jobData = {};
        
        for (let [key, value] of formData.entries()) {
          jobData[key] = value;
        }
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢ JavaScript
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        if (startTimeInput.value) jobData.start_time = startTimeInput.value;
        if (endTimeInput.value) jobData.end_time = endTimeInput.value;
        
        console.log('üìù Submitting job data:', jobData);
        
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á API
        const response = await fetch('/api/jobs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(jobData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showMessage('form-message', `‚úÖ ${result.message}${result.calendarEvents && result.calendarEvents.length > 0 ? ` (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô ${result.calendarEvents.length} event)` : ''}`, 'success');
          
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
          event.target.reset();
          updateTimeBasedOnWindow(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
          
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
          const jobsTab = document.getElementById('jobs-list');
          if (jobsTab && jobsTab.classList.contains('active')) {
            console.log('üîÑ Refreshing jobs list after creation');
            loadJobs();
          }
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Job ID ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
          generateJobId();
          
        } else {
          showMessage('form-message', `‚ùå ${result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}`, 'error');
        }
        
      } catch (error) {
        console.error('Error submitting job:', error);
        showMessage('form-message', `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
      } finally {
        // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
      }
    }

    function formatThaiDate(date) {
      const thaiMonths = [
        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
      ];
      
      const day = date.getDate();
      const month = thaiMonths[date.getMonth()];
      const year = date.getFullYear() + 543;
      
      return `${day} ${month} ${year}`;
    }

    // Form submission
    document.getElementById('newJobForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const jobData = Object.fromEntries(formData);
      
      // Handle date range
      const dateType = document.getElementById('date_type').value;
      if (dateType === 'range') {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        if (!startDate || !endDate) {
          showMessage('form-message', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error');
          return;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
          showMessage('form-message', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error');
          return;
        }
        
        jobData.date_type = 'range';
        jobData.start_date = startDate;
        jobData.end_date = endDate;
        jobData.date = startDate; // Use start date as primary date
      } else {
        jobData.date_type = 'single';
        delete jobData.start_date;
        delete jobData.end_date;
      }
      
      // Basic validation
      if (!jobData.customer || !jobData.type || !jobData.status) {
        showMessage('form-message', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô, ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
        return;
      }
      
      showMessage('form-message', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô...', 'loading');
      
      try {
        const response = await fetch('/api/jobs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(jobData)
        });

        const result = await response.json();

        if (response.ok) {
          let successMsg = `
            <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); 
                        color: #155724; padding: 30px; border-radius: 15px; text-align: center; 
                        margin: 20px 0; border: 2px solid #28a745;">
              <h3 style="margin-bottom: 15px;">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h3>
              <div style="font-size: 32px; font-weight: bold; margin: 20px 0; color: #28a745;">
                üìã ${result.job.job_id}
              </div>
              <p>‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ <strong>${result.job.job_id}</strong> ‡πÅ‡∏•‡πâ‡∏ß</p>
          `;
          
          if (result.calendarEvents && result.calendarEvents.length > 0) {
            successMsg += `<p style="margin-top: 15px;">üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Calendar Events ‡πÅ‡∏•‡πâ‡∏ß: ${result.calendarEvents.length} ‡∏ß‡∏±‡∏ô</p>`;
          }
          
          successMsg += `
              <button class="btn btn-info" onclick="showTab('jobs-list'); loadJobs();" style="margin-top: 20px;">
                üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
              </button>
            </div>
          `;
          
          document.getElementById('form-message').innerHTML = successMsg;
          document.getElementById('newJobForm').reset();
          document.getElementById('job-id-preview').style.display = 'none';
          
          // Reset date inputs
          document.getElementById('date_type').value = 'single';
          toggleDateInput();
          
          // Auto switch to jobs list after 3 seconds
          setTimeout(() => {
            showTab('jobs-list');
            loadJobs();
          }, 3000);
        } else {
          showMessage('form-message', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        showMessage('form-message', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô: ' + error, 'error');
      }
    });

    // Customer input setup
    document.getElementById('customer').addEventListener('input', function(e) {
      searchCustomers(e.target.value);
    });

    document.getElementById('customer').addEventListener('blur', function() {
      setTimeout(() => {
        document.getElementById('customerSuggestions').style.display = 'none';
      }, 200);
    });

    // Load customers on page load
    loadCustomers();

    // Settings functions
    async function testConnection() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API...', 'loading');
      
      try {
        const response = await fetch('/api/health');
        const result = await response.json();
        
        if (response.ok) {
          const message = `‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥<br>
                          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${result.status}<br>
                          ‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ${result.timestamp}`;
          showMessage('settings-results', message, 'success');
          document.getElementById('system-status-text').innerHTML = 
            '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleString('th-TH') + ')';
        } else {
          showMessage('settings-results', '‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö API: ' + error, 'error');
      }
    }

    async function testCalendar() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Calendar...', 'loading');
      
      try {
        const response = await fetch('/api/calendar/test');
        const result = await response.json();
        
        if (response.ok && result.success) {
          const message = `‚úÖ Google Calendar ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥<br>
                          ${result.message}<br>
                          üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Test Event ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`;
          showMessage('settings-results', message, 'success');
        } else {
          showMessage('settings-results', `‚ùå Google Calendar ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß<br>${result.error}`, 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Calendar: ' + error, 'error');
      }
    }

    function loadSystemInfo() {
      document.getElementById('system-status-text').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö...';
      testConnection();
      getAutoDetectionStatus(); // Also load auto-detection status
    }

    // Auto-Detection functions
    async function getAutoDetectionStatus() {
      document.getElementById('auto-detection-text').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...';
      
      try {
        const response = await fetch('/api/auto-detection/status');
        const result = await response.json();
        
        if (response.ok && result.success) {
          const status = result.dailyAutoDetectionActive ? 
            '<span style="color: #28a745;">üü¢ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>' : 
            '<span style="color: #dc3545;">üî¥ ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>';
          
          const message = `
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}<br>
            ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤: ${result.timezone}<br>
            ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô: ${result.nextRun}<br>
            ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${result.activeJobs.join(', ')}<br>
            ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString('th-TH')}
          `;
          
          document.getElementById('auto-detection-text').innerHTML = message;
        } else {
          document.getElementById('auto-detection-text').innerHTML = 
            '<span style="color: #dc3545;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ</span>';
        }
      } catch (error) {
        document.getElementById('auto-detection-text').innerHTML = 
          '<span style="color: #dc3545;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message + '</span>';
      }
    }

    async function startAutoDetection() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...', 'loading');
      
      try {
        const response = await fetch('/api/auto-detection/start', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok && result.success) {
          showMessage('settings-results', '‚úÖ ' + result.message, 'success');
          getAutoDetectionStatus(); // Refresh status
        } else {
          showMessage('settings-results', '‚ùå ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    async function stopAutoDetection() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...', 'loading');
      
      try {
        const response = await fetch('/api/auto-detection/stop', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok && result.success) {
          showMessage('settings-results', '‚úÖ ' + result.message, 'success');
          getAutoDetectionStatus(); // Refresh status
        } else {
          showMessage('settings-results', '‚ùå ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    async function runAutoDetectionNow() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ...', 'loading');
      
      try {
        const response = await fetch('/api/auto-detection/run-now', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok && result.success) {
          const details = result.results;
          const message = `
            ‚úÖ ${result.message}<br>
            üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:<br>
            - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${details.totalChecked} ‡∏á‡∏≤‡∏ô<br>
            - ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${details.statusUpdated} ‡∏á‡∏≤‡∏ô<br>
            - ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß: ${details.moved} ‡∏á‡∏≤‡∏ô<br>
            - ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏•‡∏ö: ${details.deleted} ‡∏á‡∏≤‡∏ô<br>
            - ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${details.errors} ‡∏á‡∏≤‡∏ô
          `;
          showMessage('settings-results', message, 'success');
          
          // Refresh jobs list if visible
          if (document.getElementById('jobs-list').style.display !== 'none') {
            loadJobs();
          }
        } else {
          showMessage('settings-results', '‚ùå ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }
    }

    // Sync from Calendar function
    async function syncFromCalendar() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Calendar...', 'loading');
      
      try {
        const response = await fetch('/api/calendar/sync-from-calendar', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok && result.success) {
          const results = result.results;
          
          const message = `
            ‚úÖ ${result.message}<br><br>
            üìä <strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong><br>
            ‚Ä¢ Events ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö: ${results.total_events_found} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: <span style="color: #28a745;">${results.existing_jobs_updated} ‡∏á‡∏≤‡∏ô</span><br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á: <span style="color: #007bff;">${results.new_jobs_created} ‡∏á‡∏≤‡∏ô</span><br>
            ‚Ä¢ Events ‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≤‡∏°: <span style="color: #6c757d;">${results.skipped_events} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span><br>
            ‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: <span style="color: #dc3545;">${results.errors} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span><br><br>
            
            ${results.details.length > 0 ? 
              '<strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:</strong><br>' +
              results.details.slice(0, 10).map(detail => {
                const icon = detail.action === 'created' ? '‚ûï' : 
                           detail.action === 'updated' ? 'üìù' : 
                           detail.action === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
                return `${icon} ${detail.jobId || detail.eventId}: ${detail.message}`;
              }).join('<br>') +
              (results.details.length > 10 ? '<br>...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ' + (results.details.length - 10) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : '')
              : ''
            }
          `;
          
          showMessage('settings-results', message, 'success');
          
          // Refresh jobs list if visible
          if (document.getElementById('jobs-list').classList.contains('active')) {
            loadJobs();
          }
          
        } else {
          showMessage('settings-results', '‚ùå ' + (result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync'), 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Sync ‡∏à‡∏≤‡∏Å Calendar: ' + error.message, 'error');
      }
    }

    // Calendar Audit functions
    async function auditCalendar() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'loading');
      document.getElementById('audit-summary-text').innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
      
      try {
        const response = await fetch('/api/calendar/audit');
        const result = await response.json();
        
        if (response.ok && result.success) {
          const audit = result.audit;
          
          // Display summary
          const summaryText = `
            üìä <strong>‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong><br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${audit.total_jobs} ‡∏á‡∏≤‡∏ô<br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: ${audit.jobs_needing_calendar} ‡∏á‡∏≤‡∏ô<br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß: <span style="color: #28a745;">${audit.jobs_with_calendar} ‡∏á‡∏≤‡∏ô</span><br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: <span style="color: #dc3545;">${audit.jobs_without_calendar} ‡∏á‡∏≤‡∏ô</span><br>
            ‚Ä¢ ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: <span style="color: #ffc107;">${audit.jobs_with_broken_data} ‡∏á‡∏≤‡∏ô</span><br><br>
            
            üìà <strong>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong><br>
            ${Object.entries(audit.breakdown_by_status).map(([status, count]) => 
              `‚Ä¢ ${status}: ${count} ‡∏á‡∏≤‡∏ô`
            ).join('<br>')}<br><br>
            
            üë• <strong>‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°:</strong><br>
            ${Object.entries(audit.breakdown_by_team).map(([team, count]) => 
              `‚Ä¢ ${team}: ${count} ‡∏á‡∏≤‡∏ô`
            ).join('<br>')}
          `;
          
          document.getElementById('audit-summary-text').innerHTML = summaryText;
          
          // Show sync actions if there are jobs to sync
          if (audit.jobs_without_calendar > 0) {
            document.getElementById('sync-actions').style.display = 'block';
            showMessage('settings-results', 
              `‚úÖ ${result.message}<br><br>` +
              `üîß <strong>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô:</strong><br>` +
              audit.jobs_without_calendar_list.map(job => 
                `‚Ä¢ ${job.job_id}: ${job.customer} (${job.team}, ${job.date})`
              ).slice(0, 10).join('<br>') +
              (audit.jobs_without_calendar_list.length > 10 ? '<br>...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ' + (audit.jobs_without_calendar_list.length - 10) + ' ‡∏á‡∏≤‡∏ô' : ''),
              'success'
            );
          } else {
            document.getElementById('sync-actions').style.display = 'none';
            showMessage('settings-results', '‚úÖ ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°', 'success');
          }
          
          // Show broken data if any
          if (audit.jobs_with_broken_data > 0) {
            const brokenDataMsg = `<br><br>‚ö†Ô∏è <strong>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong><br>` +
              audit.jobs_with_broken_data_list.map(job => 
                `‚Ä¢ ${job.job_id}: ${job.issues.join(', ')}`
              ).join('<br>');
            
            const currentMsg = document.querySelector('#settings-results .message').innerHTML;
            document.querySelector('#settings-results .message').innerHTML = currentMsg + brokenDataMsg;
          }
          
        } else {
          showMessage('settings-results', '‚ùå ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ' + error.message, 'error');
      }
    }

    async function syncMissingEvents() {
      showMessage('settings-results', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ...', 'loading');
      
      try {
        const response = await fetch('/api/calendar/sync-missing', { method: 'POST' });
        const result = await response.json();
        
        if (response.ok && result.success) {
          const results = result.results;
          
          const message = `
            ‚úÖ ${result.message}<br><br>
            üìä <strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong><br>
            ‚Ä¢ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° sync: ${results.total_attempted} ‡∏á‡∏≤‡∏ô<br>
            ‚Ä¢ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span style="color: #28a745;">${results.successful} ‡∏á‡∏≤‡∏ô</span><br>
            ‚Ä¢ ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: <span style="color: #dc3545;">${results.failed} ‡∏á‡∏≤‡∏ô</span><br><br>
            
            ${results.details.length > 0 ? 
              '<strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏≤‡∏ô:</strong><br>' +
              results.details.slice(0, 15).map(detail => 
                `‚Ä¢ ${detail.job_id}: ${detail.status === 'success' ? '‚úÖ' : '‚ùå'} ${detail.message}`
              ).join('<br>') +
              (results.details.length > 15 ? '<br>...‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ' + (results.details.length - 15) + ' ‡∏á‡∏≤‡∏ô' : '')
              : ''
            }
          `;
          
          showMessage('settings-results', message, results.failed === 0 ? 'success' : 'warning');
          
          // Refresh audit data
          setTimeout(() => {
            auditCalendar();
          }, 2000);
          
          // Refresh jobs list if visible
          if (document.getElementById('jobs-list').style.display !== 'none') {
            loadJobs();
          }
          
        } else {
          showMessage('settings-results', '‚ùå ' + result.error, 'error');
        }
      } catch (error) {
        showMessage('settings-results', '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô: ' + error.message, 'error');
      }
    }

    // Utility functions
    function showMessage(containerId, message, type) {
      const container = document.getElementById(containerId);
      const existingMessage = container.querySelector('.message');
      
      if (existingMessage) {
        existingMessage.remove();
      }
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = message;
      
      container.insertBefore(messageDiv, container.firstChild);
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          if (messageDiv.parentNode) {
            messageDiv.remove();
          }
        }, 5000);
      }
    }
  </script>
</body>
</html>